[workspace]
authors = ["ollie-desktop <buitelaarolivier@gmail.com>"]
channels = ["conda-forge", "pytorch", "nvidia"]
name = "ugro"
platforms = ["linux-64"]
version = "0.1.0"


# ============================================================================
# Dependencies
# ============================================================================

[dependencies]
python = "3.12.*"
python-dotenv = ">=1.2.1,<2"
flask = ">=3.1.2,<4"
fastapi = ">=0.109.0"
uvicorn = ">=0.27.0"

[feature.cuda.system-requirements]
cuda = "12.1"


# ============================================================================
# PyPI Dependencies
# ============================================================================

[pypi-dependencies]
click = ">=8.1.0"
pyyaml = ">=6.0"
pydantic = ">=2.0"
typer = ">=0.9.0"
rich = ">=13.0.0"
paramiko = ">=3.0"
psutil = ">=5.9.0"
requests = ">=2.31.0"
ugro = { path = ".", editable = true }


# ============================================================================
# CPU Feature - CPU-only PyTorch
# ============================================================================

[feature.cpu.dependencies]

[feature.cpu.pypi-dependencies]
torch = { version = ">=2.5.1", index = "https://download.pytorch.org/whl/cpu" }
torchvision = { version = ">=0.20.1", index = "https://download.pytorch.org/whl/cpu" }
torchaudio = { version = "==2.7.1", index = "https://download.pytorch.org/whl/cpu" }


# ============================================================================
# GPU Feature - CUDA PyTorch
# ============================================================================

[feature.cuda.dependencies]
gcc_linux-64 = "12.*"
gxx_linux-64 = "12.*"
git = ">=2.51.0,<3"
libcusparse = ">=12.1"
libcusparse-dev = ">=12.1"
cusparselt = ">=0.6"
cusparselt-dev = ">=0.6"
nccl = ">=2.18"
cudnn = ">=8.9"
cuda-runtime = ">=12.1"

[feature.cuda.pypi-dependencies]
torch = { version = "==2.7.1", index = "https://download.pytorch.org/whl/cu128" }
torchvision = { version = "==0.22.1", index = "https://download.pytorch.org/whl/cu128" }
torchaudio = { version = "==2.7.1", index = "https://download.pytorch.org/whl/cu128" }


# ============================================================================
# Test Feature
# ============================================================================

[feature.test.dependencies]
pytest = ">=7.0"
pytest-asyncio = ">=0.23"
pytest-cov = ">=4.0"
black = ">=23.0"
ruff = ">=0.1.0"
mypy = ">=1.0"


# ============================================================================
# Monitor Features
# ============================================================================

[feature.monitor.pypi-dependencies]
prometheus-client = ">=0.17.0"
flask = ">=2.3.0"


# ============================================================================
# HPO (Hyperparameter Optimization) Feature
# ============================================================================

[feature.hpo.pypi-dependencies]
ray = { version = ">=2.9.0", extras = ["tune"] }
optuna = ">=3.4.0"
mlflow = ">=2.9.0"
wandb = ">=0.16.0"
peft = ">=0.7.0"
datasets = ">=2.16.0"
matplotlib = ">=3.8.0"
pandas = ">=2.1.0"


# ============================================================================
# Environments
# ============================================================================

[environments]
default = { features = [], solve-group = "default" }
cuda = { features = ["cuda"], solve-group = "default" }
monitor = { features = ["monitor"], solve-group = "default" }
test = { features = ["test", "cpu", "monitor", "hpo"] }
cpu = { features = ["cpu"] }
hpo = { features = ["hpo", "cuda"], solve-group = "default" }



# ============================================================================
# Tasks
# ============================================================================

[tasks]
ugro = "python -m ugro.cli"
ugro-health = "python -m ugro.cli health"
ugro-test-health = "python src/test_cluster_health.py"
test = "pytest -q"
cov = "pytest --cov=ugro --cov-report=term-missing"
lint = "ruff check ."
fmt = "black ."
typecheck = "mypy ."
monitor = "python -m ugro.monitor"
